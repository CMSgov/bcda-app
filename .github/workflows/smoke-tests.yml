name: 'BCDA Smoke Tests'

on:
  pull_request:
    paths:
      - .github/workflows/smoke-tests.yml
  workflow_dispatch:
    inputs:
      app-branch:
        description: The branch of the bcda-app to use for the test execution.
        required: true
        type: 'string'
        default: 'main'
      ops-branch:
        description: The branch of the bcda-ops to use for the test execution.
        required: true
        type: 'string'
        default: 'main'
      ssas-app-branch:
        description: The branch of the ssas-app to use for the test execution.
        required: true
        type: 'string'
        default: 'main'
      ssas-ops-branch:
        description: The branch of the ssas-ops to use for the test execution.
        required: true
        type: 'string'
        default: 'main'
      env:
        description: The environment in which to run smoke tests
        required: true
        type: choice
        options:
          - 'dev'
          - 'test'
          - 'opensbx'
          - 'prod'
      test-aco:
        description: Run the tests using the selected ACO
        required: true
        type: choice
        options:
          - 'small'
          - 'medium'
          - 'large'
          - 'extra-large'
          - 'dev'
          - 'paca'
        default: 'dev'
      smoke-tests:
        description: Flag which indicates if smoke integration tests should be run
        required: true
        type: boolean
        default: true
      postman-tests:
        description: Flag which indicates if smoke integration tests should be run
        required: true
        type: boolean
        default: true
      eoy:
        description: The type of maintenance mode to put the application into. Empty string means no maintenance (i.e. normal)
        required: true
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ inputs.env }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  COMPOSE_INTERACTIVE_NO_CLI: 1
  VAULT_PW: ${{ secrets.VAULT_PW }}



  # app_smoke_tests:
  #   name: bcda-api smoke tests
  #   runs-on: self-hosted
  #   env:
  #     DOCKER_BUILDKIT: 1
  #     COMPOSE_DOCKER_CLI_BUILD: 1
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v2
  #     - name: Install Ansible
  #       run: |
  #         sudo yum update -y
  #         sudo yum install python3-pip -y
  #         python3 -m pip install ansible==6.5.0
  #     - name: Decrypt secrets
  #       run: |
  #         echo $VAULT_PW > .vault_password
  #         bash ops/secrets --decrypt
  #         mv -fv shared_files/encrypted/* shared_files/decrypted/
  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v1
  #     - name: Build Test Image
  #       run: |
  #         docker compose -f docker-compose.test.yml build
  #     - uses: cmsgov/ab2d-bcda-dpc-platform/actions/aws-params-env-action@main
  #       env:
  #         AWS_REGION: ${{ vars.AWS_REGION }}
  #       with:
  #         params: |
  #           CLIENT_CREDENTIALS=/bcda/workflows/dev_client_credentials
  #           DENYLIST_CLIENT_CREDENTIALS=/bcda/workflows/deny_client_credentials
  #           TEST_PARAM=/bcda/workflows/test_quotes
  #     - name: Build Test Image
  #       run: |
  #         CLIENT_ID=$(echo $CLIENT_CREDENTIALS | jq .client_id)
  #         CLIENT_SECRET=$(echo $CLIENT_CREDENTIALS | jq .client_secret)
  #         DENY_CLIENT_ID=$(echo $CLIENT_CREDENTIALS | jq .client_id)
  #         DENY_CLIENT_SECRET=$(echo $CLIENT_CREDENTIALS | jq .client_secret)

  #         docker compose -f docker-compose.test.yml run --rm postman_test test/postman_test/BCDA_Tests_Sequential.postman_collection.json \
  #         -e test/postman_test/dev.postman_environment.json \
  #         --global-var clientId=${CLIENT_ID} --global-var clientSecret=${CLIENT_SECRET} \
  #         --global-var v2Disabled=false \
  #         --global-var blacklistedClientId=${DENYLIST_CLIENT_ID} --global-var blacklistedClientSecret=${DENYLIST_CLIENT_SECRET} \
  #         #--global-var maintenanceMode=""


jobs:
  get_params:
    name: get parameters
    runs-on: self-hosted
    outputs:
      client_credentials: ${{ steps.getparams.outputs.client_credentials }}
      denylist_client_credetials: ${{ steps.getparams.outputs.denylist_client_credetials }}
    steps:
      - uses: cmsgov/ab2d-bcda-dpc-platform/actions/aws-params-env-action@main
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
        with:
          params: |
            CLIENT_CREDENTIALS_PARAMS=/bcda/workflows/dev_client_credentials
            DENYLIST_CLIENT_CREDENTIALS_PARAMS=/bcda/workflows/deny_client_credentials
      - name: Set Output
        id: getparams
        run: |
          echo "CLIENT_CREDENTIALS=${CLIENT_CREDENTIALS_PARAMS} >> "$GITHUB_OUTPUT"
          echo "DENYLIST_CLIENT_CREDENTIALS=${DENYLIST_CLIENT_CREDENTIALS_PARAMS} >> "$GITHUB_OUTPUT"
  api_smoke_tests: 
    name: run api smoke tests
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: 1
      COMPOSE_DOCKER_CLI_BUILD: 1
    steps:
      # - name: Checkout code
      #   uses: actions/checkout@v2
      # - name: Install Ansible
      #   run: |
      #     #sudo yum update -y
      #     sudo yum install python3-pip -y
      #     python3 -m pip install ansible==6.5.0
      - name: Decrypt secrets
        run: |
          echo $VAULT_PW > .vault_password
          bash ops/secrets --decrypt
          mv -fv shared_files/encrypted/* shared_files/decrypted/
      # - uses: cmsgov/ab2d-bcda-dpc-platform/actions/aws-params-env-action@main
      #   env:
      #     AWS_REGION: ${{ vars.AWS_REGION }}
      #   with:
      #     params: |
      #       CLIENT_CREDENTIALS_PARAMS=/bcda/workflows/dev_client_credentials
      #       DENYLIST_CLIENT_CREDENTIALS_PARAMS=/bcda/workflows/deny_client_credentials
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Build the stack
        run: |
          make docker-bootstrap
      - name: Run all tests
        env:
          CLIENT_CREDENTIALS_PARAMS: ${{needs.get_params.outputs.CLIENT_CREDENTIALS_PARAMS}}
          DENYLIST_CLIENT_CREDENTIALS_PARAMS: ${{needs.get_params.outputs.DENYLIST_CLIENT_CREDENTIALS_PARAMS}}
        run: |
          CLIENT_ID=$(echo $CLIENT_CREDENTIALS_PARAMS | jq .client_id)
          CLIENT_SECRET=$(echo $CLIENT_CREDENTIALS_PARAMS | jq .client_secret)
          DENY_CLIENT_ID=$(echo $DENYLIST_CLIENT_CREDENTIALS_PARAMS | jq .client_id)
          DENY_CLIENT_SECRET=$(echo $DENYLIST_CLIENT_CREDENTIALS_PARAMS | jq .client_secret)

          make postman env=dev CLIENT_ID="${CLIENT_ID}" CLIENT_SECRET="$CLIENT_SECRET" BLACKLIST_CLIENT_ID=$DENY_CLIENT_ID BLACKLIST_CLIENT_SECRET=$DENY_CLIENT_SECRET maintenanceMode=""
          # make smoke-test env=dev maintenanceMode=""
      - name: Archive code coverage results
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-report
          path: ./test_results/latest/testcoverage.out

# checkout app
    # checkout ssas
    # decrypt secrets
    # build app image
    # build ssas image 
    # run ssas postman tests
    # refresh cclf files
    # run api postman tests
    # run smoke tests
    # run paca smoke tests

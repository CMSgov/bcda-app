name: "BCDA CI Workflow"

on: [push]

jobs:
  build:
    name: "Build and Test"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v1
      - name: "Decrypt secrets"
        env:
          VAULT_PW: ${{ secrets.VAULT_PW }}
        run: |
          echo $VAULT_PW > .vault_password
          bash ops/secrets --decrypt
          mv -fv shared_files/encrypted/* shared_files/decrypted/
      - name: "Build the stack"
        env:
          COMPOSE_INTERACTIVE_NO_CLI: 1
        run: |
          make docker-bootstrap
      - name: "Run all tests"
        env:
          COMPOSE_INTERACTIVE_NO_CLI: 1
        run: |
          make test
